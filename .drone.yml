kind: pipeline
name: default

steps:
  - name: build
    image: node:18.18.0
    commands:
      - yarn install
      - yarn build

  - name: deploy
    image: appleboy/drone-scp
    settings:
      host: 3.96.197.221
      username: ubuntu
      key:
        from_secret: ssh_key
      port: 22
      strip_components: 0
      target: /home/ubuntu/app/jira-clone
      source:
        - .next/
        - public/
        - package.json
        - yarn.lock
        - next.config.js
        # 不拷貝 node_modules，讓 EC2 用 yarn install --production 補齊

  - name: restart-app
    image: appleboy/drone-ssh
    settings:
      host: 3.96.197.221
      username: ubuntu
      key:
        from_secret: ssh_key
      port: 22
      script:
        - cd /home/ubuntu/app/jira-clone
        - yarn install --production # 在伺服器上安裝生產依賴
        - pm2 delete jira-clone || true # 刪除舊程序
        - pm2 start "npx next start -p 3001" --name jira-clone # 直接用 next start 啟動且帶 port
        - sleep 5
        - sudo systemctl reload nginx
